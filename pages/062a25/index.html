<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HMR热更新原理 | Lyc&#39;s blog </title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/blog/assets/css/0.styles.37fe0390.css" as="style"><link rel="preload" href="/blog/assets/js/app.4a3d1442.js" as="script"><link rel="preload" href="/blog/assets/js/2.e2e64146.js" as="script"><link rel="preload" href="/blog/assets/js/19.1292f262.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.2235f657.js"><link rel="prefetch" href="/blog/assets/js/11.f5ad667a.js"><link rel="prefetch" href="/blog/assets/js/12.0e01683e.js"><link rel="prefetch" href="/blog/assets/js/13.3128a710.js"><link rel="prefetch" href="/blog/assets/js/14.c5e78275.js"><link rel="prefetch" href="/blog/assets/js/15.5905ce1e.js"><link rel="prefetch" href="/blog/assets/js/16.9f119347.js"><link rel="prefetch" href="/blog/assets/js/17.679c41e1.js"><link rel="prefetch" href="/blog/assets/js/18.8e903e8e.js"><link rel="prefetch" href="/blog/assets/js/20.90095401.js"><link rel="prefetch" href="/blog/assets/js/21.6a7bdc85.js"><link rel="prefetch" href="/blog/assets/js/22.ca5c587e.js"><link rel="prefetch" href="/blog/assets/js/23.998636e7.js"><link rel="prefetch" href="/blog/assets/js/24.eb30b92b.js"><link rel="prefetch" href="/blog/assets/js/25.d8c8c9e6.js"><link rel="prefetch" href="/blog/assets/js/26.9103af9c.js"><link rel="prefetch" href="/blog/assets/js/27.cc8d9d34.js"><link rel="prefetch" href="/blog/assets/js/3.af9ad256.js"><link rel="prefetch" href="/blog/assets/js/4.66980020.js"><link rel="prefetch" href="/blog/assets/js/5.01d9d731.js"><link rel="prefetch" href="/blog/assets/js/6.c52e28fc.js"><link rel="prefetch" href="/blog/assets/js/7.69a71270.js"><link rel="prefetch" href="/blog/assets/js/8.842597f7.js"><link rel="prefetch" href="/blog/assets/js/9.90677151.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.37fe0390.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lyc's blog </span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/blog/ui/" class="nav-link">页面</a></div><div class="nav-item"><a href="/blog/technology/" class="nav-link">技术</a></div> <a href="https://github.com/lyc2014/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/blog/imgs/avatar.jpg"> <div class="blogger-info"><h3>Leonardo</h3> <span>前端界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/blog/ui/" class="nav-link">页面</a></div><div class="nav-item"><a href="/blog/technology/" class="nav-link">技术</a></div> <a href="https://github.com/lyc2014/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>原理知识</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>webpack学习</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/4b8934/" class="sidebar-link">简单解读下webpack输出的代码</a></li><li><a href="/blog/pages/062a25/" aria-current="page" class="active sidebar-link">HMR热更新原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/blog/pages/062a25/#hmr热更新原理" class="sidebar-link">HMR热更新原理</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/062a25/#hmr的疑惑" class="sidebar-link">HMR的疑惑</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/062a25/#hmr用例详解" class="sidebar-link">HMR用例详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#第一步-webpack-对文件进行监测并打包" class="sidebar-link">第一步，webpack 对文件进行监测并打包</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#为什么要将打包内容保存到内存中去呢" class="sidebar-link">为什么要将打包内容保存到内存中去呢</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#第二步-devserver-通知浏览器端文件发生变化" class="sidebar-link">第二步，devServer 通知浏览器端文件发生变化</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#第三步-浏览器端的-webpack-dev-server-client-接受消息并作出响应" class="sidebar-link">第三步，浏览器端的 webpack-dev-server/client 接受消息并作出响应</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#第四步-webpack-接收到最新-hash-值验证并请求模块代码" class="sidebar-link">第四步，webpack 接收到最新 hash 值验证并请求模块代码</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#第五步-hotmodulereplacement-runtime-进行热更新" class="sidebar-link">第五步，HotModuleReplacement.runtime 进行热更新</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#当热更新出错了怎么办" class="sidebar-link">当热更新出错了怎么办</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#最后更新页面" class="sidebar-link">最后更新页面</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/062a25/#最新-hmr-的改变" class="sidebar-link">最新 HMR 的改变</a></li></ul></li></ul></li><li><a href="/blog/pages/bfddcd/" class="sidebar-link">webpack核心打包流程学习笔记</a></li><li><a href="/blog/pages/e18f26/" class="sidebar-link">简易webpack打包器</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJs</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/blog/technology/#技术" data-v-06225672>技术</a></li><li data-v-06225672><a href="/blog/technology/#webpack学习" data-v-06225672>webpack学习</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/lyc2014" target="_blank" title="作者" class="beLink" data-v-06225672>liyuancheng</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-03-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">HMR热更新原理<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="hmr热更新原理"><a href="#hmr热更新原理" class="header-anchor">#</a> HMR热更新原理</h2> <p><strong>Hot Module Replacement</strong>（简称HMR）是<strong>webpack</strong>发展至今令人最兴奋的特性之一，当你对代码进行修改并保存后，<strong>webpack</strong>将对代码重新打包，并将新的模块发送到浏览器端，浏览器通过新的模块替换老的模块，这样在不刷新浏览器的前提下就能够应用进行更新。例如我们在开发网站的时候，发现某个元素样式需要调整，这个时候你只需要在代码里修改对应的样式，然后保存，在浏览器没有刷新的前提下，这个元素的样式已经进行了改变，这种开发体验就好像直接在chrome里面直接对元素进行了改变一样，十分好用。</p> <h2 id="hmr的疑惑"><a href="#hmr的疑惑" class="header-anchor">#</a> HMR的疑惑</h2> <p>现在的我们基本上都是使用 <strong>webpack</strong> 模式开发，修改了代码之后，页面会直接进行改变，但是很少有人想过，为什么页面不刷新就会直接改变了？</p> <p>初识 HMR 的时候，觉得神奇的同时，脑海中一直有一些疑问：</p> <ul><li>一般来说，<strong>webpack</strong> 会将不同的模块打包成不同 <strong>bundle</strong> 或 <strong>chunk</strong> 文件， 但是在使用 <strong>webpack</strong> 进行 <strong>dev</strong> 模式开发的时候，我并没有在我的 <strong>dist</strong> 目录中找到 webpack 打包好的文件，它们去哪了呢？</li> <li>在查看 <strong>webpack-dev-server</strong> 的 <strong>package.json</strong> 文件中，我发现了 <strong>webpack-dev-middleware</strong> 这个依赖，这个 <strong>webpack-dev-middleware</strong> 又有什么作用呢？</li> <li>在研究 <strong>HMR</strong> 的过程中，通过 <strong>Chrome</strong> 的开发者工具，我知道浏览器是通过 <strong>websocket</strong> 和 <strong>webpack-dev-server</strong> 进行通信的，但是我在 <strong>websocket</strong> 中并没有发现任何代码块。那么新的代码块是怎么跑到浏览器的呢？这个 <strong>websocket</strong> 又有什么作用？为什么不通过 <strong>websocket</strong> 进行新旧代码块的替换？</li> <li>浏览器如何进行替换最新代码？替换过程中如今处理依赖关系？替换失败了会怎样？</li></ul> <p>带着这些疑惑，我去探究了一下 HMR。</p> <img src="/blog/imgs/03技术/16d7184d654dea3e_tplv-t2oaga2asx-image.image" alt="热更新"> <p>没错，这是一张 <strong>HMR</strong> 工作原理流程图。</p> <p>上图显示了我们从修改代码开始触发 <strong>webpack</strong> 打包，到浏览器端热更新的一个流程，我已经通过小标识将步骤进行了标记。</p> <ol><li>在<strong>webpack</strong>的 <strong>dev</strong> 模式下，<strong>webpack</strong>会<strong>watch</strong>文件系统的文件修改，一旦监听到文件变化，<strong>webpack</strong>就会对相关模块进行重新打包，打包完之后会将代码保存在内存中。</li> <li><strong>webpack</strong>和<strong>webpack-dev-server</strong>之间的交互，其中，主要是利用<strong>webpack-dev-server</strong>里的<strong>webpack-dev-middleware</strong>这个中间件调用<strong>webpack</strong>暴露给外部的<strong>API</strong>对代码变化进行的监控。</li> <li>第三步是<strong>webpack-dev-server</strong>对静态文件变化的监控，这一步和第一步不同，并不是要监控代码进行重新打包，而是监听配置文件中静态文件的变化，如果发生变化，则会通知浏览器需要重新加载，即<strong>live reload</strong>（刷新），和 <strong>HMR</strong>不一样。具体配置为，在相关配置文件配置 <strong>devServer.watchContentBase</strong>。</li> <li>服务器端的<strong>webpack-dev-server</strong> 利用 <strong>sockjs</strong>在浏览器和服务器之间建立一个<strong>websocket</strong>长链接，将 <strong>webpack</strong> 打包变化信息告诉浏览器端的<strong>webpack-dev-server</strong>，这其中也包括静态文件的改变信息，当然，这里面最重要的就是每次打包生成的不同 <strong>hash</strong> 值。</li> <li>浏览器端的 <strong>webpack-dev-server</strong> 接收到服务器端的请求，他自身并不会进行代码的替换，他只是一个中间商，当接收到的信息有变化时，他会通知 <strong>webpack/hot/dev-server</strong>， 这是 <strong>webpack</strong> 的功能模块，他会根据浏览器端的 <strong>webpack-dev-server</strong> 传递的信息以及 <strong>dev-server</strong> 的配置，决定浏览器是执行刷新操作还是热更新操作。</li> <li>如果是刷新操作，则直接通知浏览器进行刷新。如果是热更新操作，则会通知热加载模块 <strong>HotModuleReplacement.runtime</strong>，这个 <strong>HotModuleReplacement.runtime</strong>是浏览器端 <strong>HMR</strong> 的中枢系统，他负责接收上一步传递过来的 <strong>hash</strong> 值，然后通知并等待下一个模块即 <strong>JsonpMainTemplate.runtime</strong> 向服务器发送请求的结果。</li> <li><strong>HotModuleReplacement.runtime</strong>通知<strong>JsonpMainTemplate.runtime</strong>模块要进行新的代码请求，并等待其返回的代码块。</li> <li><strong>JsonpMainTemplate.runtime</strong>先向服务端发送请求，请求包含 <strong>hash</strong> 值得 <strong>json</strong> 文件。</li> <li>获取到所有要更新模块的 <strong>hash</strong> 值之后，再次向服务端发送请求，通过 <strong>jsonp</strong> 的形式，获取到最新的代码块，并将此代码块发送给 <strong>HotModulePlugin</strong>。</li> <li><strong>HotModulePlugin</strong> 将会对新旧模块进行对比，决定是否需要更新，若需要更新，则会检查其依赖关系，更新模块的同时更新模块间的引用。</li></ol> <h2 id="hmr用例详解"><a href="#hmr用例详解" class="header-anchor">#</a> HMR用例详解</h2> <p>在上一个部分，作者根据示意图简述了 <strong>HMR</strong> 的工作原理，当然，你可能觉得了解了一个大概，细节部分仍然是很模糊，对上面出现的英文单词也感觉很陌生，没关系，接下来，我会通过最纯粹的一个小栗子，结合源码来一步一步说明每个部分的内容。</p> <p>我们从最简单的例子开始说明，以下是这个 demo 的具体文件</p> <div class="language-code extra-class"><pre class="language-text"><code>--hello.js;
--index.js;
--index.html;
--package.json;
--webpack.config.js;
</code></pre></div><p>其中 hello.js 为以下代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> hello<span class="token punctuation">;</span>
</code></pre></div><p>index.js 文件为以下代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> hello <span class="token keyword">from</span> <span class="token string">'./hello.js'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElemenet</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>webpack.config.js 文件为以下代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./index.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们使用 npm install 安装完依赖，并启动 devServer服务器。</p> <p>接下来，我们进入关键环节，改变文件内容，触发 HMR。</p> <div class="language-code extra-class"><pre class="language-text"><code>// hello.js
- const hello = () =&gt; 'hello world'
+ const hello = () =&gt; 'hello nice'
</code></pre></div><p>这个时候页面就从 hello world 渲染为 hello nice。
我们从这个过程，一步一步详细解析一下热更新的过程及原理。</p> <h3 id="第一步-webpack-对文件进行监测并打包"><a href="#第一步-webpack-对文件进行监测并打包" class="header-anchor">#</a> 第一步，webpack 对文件进行监测并打包</h3> <img src="/blog/imgs/03技术/16d7184d603836b6_tplv-t2oaga2asx-image.image" alt="热更新"> <p><strong>webpack-dev-middleware</strong> 调用 <strong>webpack</strong> 中的 <strong>api</strong> 来监测文件系统的改变，当 <strong>hello.js</strong> 文件发生了改变，<strong>webpack</strong> 对其进行重新打包，将打包的内容保存到内存中去。
具体代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-middleware/lib/Shared.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> watching <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>
    options<span class="token punctuation">.</span>watchOptions<span class="token punctuation">,</span>
    share<span class="token punctuation">.</span>handleCompilerCallback
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>watching <span class="token operator">=</span> watching<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那为什么 <strong>webpack</strong> 没有将文件直接打包到 <strong>output.path</strong> 呢？这些文件都没有了系统是怎么访问的呢？</p> <p>原来 <strong>webpack</strong> 将文件打包到内存中去了。</p> <h3 id="为什么要将打包内容保存到内存中去呢"><a href="#为什么要将打包内容保存到内存中去呢" class="header-anchor">#</a> 为什么要将打包内容保存到内存中去呢</h3> <p>这样做的理由就是能更快的访问文件，减少代码写入的开销。这就归功于 <strong>memory-js</strong> 这个库，<strong>webpack-dev-middleware</strong> 依赖此库，同时将 <strong>webpack</strong> 中原来的 <strong>outputFileSystem</strong> 替换成了 <strong>MemoryFileSystem</strong> 实例，这样代码就输出到内存中去了，其中一部分源码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-middleware/lib/Shared.js</span>
<span class="token comment">// 首先判断当前 fileSystem 是否已经是 MemoryFileSystem 的实例</span>
<span class="token keyword">var</span> isMemoryFs <span class="token operator">=</span>
  <span class="token operator">!</span>compiler<span class="token punctuation">.</span>compilers <span class="token operator">&amp;&amp;</span> compiler<span class="token punctuation">.</span>outputFileSystem <span class="token keyword">instanceof</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isMemoryFs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果不是，用 MemoryFileSystem 的实例替换 compiler 之前的 outputFileSystem</span>
  fs <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="第二步-devserver-通知浏览器端文件发生变化"><a href="#第二步-devserver-通知浏览器端文件发生变化" class="header-anchor">#</a> 第二步，devServer 通知浏览器端文件发生变化</h3> <img src="/blog/imgs/03技术/16d7184d67d8a81b_tplv-t2oaga2asx-image.image" alt="热更新"> <p>这一阶段，是利用 <strong>sockjs</strong> 来进行浏览器和服务器之间的通讯。</p> <p>在启动 <strong>devServer</strong> 的时候，<strong>sockjs</strong> 在浏览器和服务器之间建立了一个 <strong>websocket</strong> 长链接，以便能够实时通知浏览器打包动向，这其中最关键的部分还是 <strong>webpack-dev-server</strong> 调用 <strong>webpack</strong> 的 <strong>api</strong> 来监听 <strong>compile</strong> 的 <strong>done</strong> 事件，当编译完成时，<strong>webpack-dev-server</strong> 通过 <strong>_sendStatus</strong> 方法将新模块的 <strong>hash</strong> 值发送给浏览器。其中关键代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-server/lib/Server.js</span>
compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// stats.hash 是最新打包文件的 hash 值</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_sendStats</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">,</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>clientStats<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token class-name">Server</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_sendStats</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sockets<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> force</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> stats <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span><span class="token operator">!</span>stats<span class="token punctuation">.</span>errors <span class="token operator">||</span> stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span>assets <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span>assets<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">asset</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>asset<span class="token punctuation">.</span>emitted<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'still-ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// 调用 sockWrite 方法将 hash 值通过 websocket 发送到浏览器端</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'hash'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'errors'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'warnings'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>warnings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="第三步-浏览器端的-webpack-dev-server-client-接受消息并作出响应"><a href="#第三步-浏览器端的-webpack-dev-server-client-接受消息并作出响应" class="header-anchor">#</a> 第三步，浏览器端的 webpack-dev-server/client 接受消息并作出响应</h3> <img src="/blog/imgs/03技术/16d7184d95343427_tplv-t2oaga2asx-image.image" alt="热更新"> <p>当 <strong>webpack-dev-server/client</strong> 接受到 <strong>type</strong> 为 <strong>hash</strong> 消息后，会将 <strong>hash</strong> 暂存起来，当接收到 <strong>type</strong> 为 <strong>ok</strong> 的消息后，对应执行 <strong>reload</strong> 操作</p> <img src="/blog/imgs/03技术/16d7184d651703dd_tplv-t2oaga2asx-image.image" alt="热更新"> <p>在 <strong>reload</strong> 中，<strong>webpack-dev-server/client</strong> 会根据 <strong>hot</strong> 配置决定是 <strong>HMR</strong> 热更新还是进行浏览器刷新，具体代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-server/client/index.js</span>
<span class="token function-variable function">hash</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">msgHash</span><span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentHash <span class="token operator">=</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function-variable function">ok</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">msgOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span>
<span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是热加载</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'[WDS] App hot update...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/hot/emitter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'webpackHotUpdate'</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 否则就刷新</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'[WDS] App updated. Reloading...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="第四步-webpack-接收到最新-hash-值验证并请求模块代码"><a href="#第四步-webpack-接收到最新-hash-值验证并请求模块代码" class="header-anchor">#</a> 第四步，webpack 接收到最新 hash 值验证并请求模块代码</h3> <img src="/blog/imgs/03技术/16d7184d6ab170ec_tplv-t2oaga2asx-image.image" alt="热更新"> <p>这一步，主要是 <strong>webpack</strong> 的三个模块之间的配合：</p> <ol><li><strong>webpack/hot/dev-derver</strong> 监听 <strong>webpack-dev-server/client</strong> 发送的 <strong>webpackHotUpdate</strong>，并调用 <strong>HotModuleReplacement.runtime</strong> 中的 <strong>check</strong> 方法，监测是否有更新。</li> <li>监测过程中会使用 <strong>JsonpMainTemplate.runtime</strong> 中的两个方法 <strong>hotDownloadUpdateChunk</strong>，<strong>hotDownloadManifest</strong>，第二个方法是调用 <strong>ajax</strong> 想服务器发送请求是否有更新文件，如有，则将更新文件列表返回浏览器端，第一个方法是通过 <strong>jsonp</strong> 请求最新代码块，同时将代码返回给 <strong>HotModuleReplacement</strong>。</li> <li><strong>HotModuleReplacement</strong> 根据拿到的代码块做处理。</li></ol> <img src="/blog/imgs/03技术/16d7184d651338c4_tplv-t2oaga2asx-image.image" alt="热更新"> <img src="/blog/imgs/03技术/16d7184d9ffa8355_tplv-t2oaga2asx-image.image" alt="热更新"> <p>如上图所示，两次请求都是使用的上一次 <strong>hash</strong> 值拼接而成的文件名，一个是对应的 hash 值，一个是对应的代码块。</p> <h4 id="为什么不直接使用-websocket-来进行更新代码呢"><a href="#为什么不直接使用-websocket-来进行更新代码呢" class="header-anchor">#</a> 为什么不直接使用 websocket 来进行更新代码呢</h4> <p>我个人觉得，大概是作者想把功能解耦，各个模块干自己的事，<strong>websocket</strong> 在这里的设计只是进行消息的传递。
在使用 <strong>webpack-hot-middleware</strong> 中有件有意思的事，它没有使用 <strong>websocket</strong>，而是使用的 <strong>EventSource</strong>，感兴趣的可以去了解下。</p> <h3 id="第五步-hotmodulereplacement-runtime-进行热更新"><a href="#第五步-hotmodulereplacement-runtime-进行热更新" class="header-anchor">#</a> 第五步，HotModuleReplacement.runtime 进行热更新</h3> <img src="/blog/imgs/03技术/16d7184da902fdf9_tplv-t2oaga2asx-image.image" alt="热更新"> <p>这一步很关键，因为所有的热更新操作都在这一步完成，主要过程就在 <strong>HotModuleReplacement.runtime</strong> 的 <strong>hotApply</strong> 这个方法中，下面我摘取了部分代码片段：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack/lib/HotModuleReplacement.runtime</span>
<span class="token keyword">function</span> <span class="token function">hotApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">var</span> idx<span class="token punctuation">;</span>
  <span class="token keyword">var</span> queue <span class="token operator">=</span> outdatedModules<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    moduleId <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 删除过期的模块</span>
    <span class="token keyword">delete</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除过期的依赖</span>
    <span class="token keyword">delete</span> outdatedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 移除所有子节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> module<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> child <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>module<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
      idx <span class="token operator">=</span> child<span class="token punctuation">.</span>parents<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">.</span>parents<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// 插入新的代码</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> appliedUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>appliedUpdate<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> appliedUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的方法可以看出，这一共经历了三个阶段</p> <ol><li>找出过期模块和过期依赖</li> <li>删除过期模块和过期依赖</li> <li>将新的模块添加到 <strong>modules</strong> 中，当下次调用 <strong>webpack_require</strong> 时，就是获取新的模块了。</li></ol> <h3 id="当热更新出错了怎么办"><a href="#当热更新出错了怎么办" class="header-anchor">#</a> 当热更新出错了怎么办</h3> <p>如果在热更新过程中出现错误，热更新将回退到刷新浏览器，这部分代码在 <strong>dev-server</strong> 代码中，简要代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>hot
  <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">updatedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是否有更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>updatedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 没有就刷新</span>
      <span class="token keyword">return</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> status <span class="token operator">=</span> module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果出错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token string">'fail'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 刷新</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="最后更新页面"><a href="#最后更新页面" class="header-anchor">#</a> 最后更新页面</h3> <p>当用新的模块代码替换老的模块后，但是我们的业务代码并不能知道代码已经发生变化，也就是说，当 <strong>hello.js</strong> 文件修改后，我们需要在 <strong>index.js</strong> 文件中调用 <strong>HMR</strong> 的 <strong>accept</strong> 方法，添加模块更新后的处理函数，及时将 <strong>hello</strong> 方法的返回值插入到页面中。
以下是部分代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'./hello.js'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这就是 <strong>HMR</strong> 的整个工作流程了。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>这篇文章没有对 <strong>HMR</strong> 对过于详尽的解析，很多细节方面也没有说明，只是简述了一下 <strong>HMR</strong> 的工作流程，希望这篇文章能帮助你更好的了解 <strong>webpack</strong>。</p> <h3 id="最新-hmr-的改变"><a href="#最新-hmr-的改变" class="header-anchor">#</a> 最新 HMR 的改变</h3> <p><strong>P.S</strong> 新版的 <strong>HMR</strong> 已经做出了改变，使用 <strong>websocket</strong> 进行代码替换，不再是通过 <strong>jsonp</strong> 插入代码块，但仍然是通过 <strong>jsonp</strong> 获取热更新的 <strong>json</strong> 文件来确定 <strong>hash</strong> 值。</p> <img src="/blog/imgs/03技术/16d7184da2ff03a5_tplv-t2oaga2asx-image.image" alt="热更新"></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">3/27/2023, 3:48:20 PM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/blog/pages/4b8934/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">简单解读下webpack输出的代码</div></a> <a href="/blog/pages/bfddcd/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">webpack核心打包流程学习笔记</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/pages/4b8934/" class="prev">简单解读下webpack输出的代码</a></span> <span class="next"><a href="/blog/pages/bfddcd/">webpack核心打包流程学习笔记</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/pages/d8cae9/"><div>
            01.Buffer的神秘面纱
            <!----></div></a> <span class="date">02-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/pages/e18f26/"><div>
            简易webpack打包器
            <!----></div></a> <span class="date">04-16</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/pages/b086bd/"><div>
            JS模块化规范笔记
            <!----></div></a> <span class="date">04-10</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.4a3d1442.js" defer></script><script src="/blog/assets/js/2.e2e64146.js" defer></script><script src="/blog/assets/js/19.1292f262.js" defer></script>
  </body>
</html>
