<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript----执行环境、变量对象、作用域链 | Lyc&#39;s blog </title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/blog/assets/css/0.styles.37fe0390.css" as="style"><link rel="preload" href="/blog/assets/js/app.4a3d1442.js" as="script"><link rel="preload" href="/blog/assets/js/2.e2e64146.js" as="script"><link rel="preload" href="/blog/assets/js/10.2235f657.js" as="script"><link rel="prefetch" href="/blog/assets/js/11.f5ad667a.js"><link rel="prefetch" href="/blog/assets/js/12.0e01683e.js"><link rel="prefetch" href="/blog/assets/js/13.3128a710.js"><link rel="prefetch" href="/blog/assets/js/14.c5e78275.js"><link rel="prefetch" href="/blog/assets/js/15.5905ce1e.js"><link rel="prefetch" href="/blog/assets/js/16.9f119347.js"><link rel="prefetch" href="/blog/assets/js/17.679c41e1.js"><link rel="prefetch" href="/blog/assets/js/18.8e903e8e.js"><link rel="prefetch" href="/blog/assets/js/19.1292f262.js"><link rel="prefetch" href="/blog/assets/js/20.90095401.js"><link rel="prefetch" href="/blog/assets/js/21.6a7bdc85.js"><link rel="prefetch" href="/blog/assets/js/22.ca5c587e.js"><link rel="prefetch" href="/blog/assets/js/23.998636e7.js"><link rel="prefetch" href="/blog/assets/js/24.eb30b92b.js"><link rel="prefetch" href="/blog/assets/js/25.d8c8c9e6.js"><link rel="prefetch" href="/blog/assets/js/26.9103af9c.js"><link rel="prefetch" href="/blog/assets/js/27.cc8d9d34.js"><link rel="prefetch" href="/blog/assets/js/3.af9ad256.js"><link rel="prefetch" href="/blog/assets/js/4.66980020.js"><link rel="prefetch" href="/blog/assets/js/5.01d9d731.js"><link rel="prefetch" href="/blog/assets/js/6.c52e28fc.js"><link rel="prefetch" href="/blog/assets/js/7.69a71270.js"><link rel="prefetch" href="/blog/assets/js/8.842597f7.js"><link rel="prefetch" href="/blog/assets/js/9.90677151.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.37fe0390.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lyc's blog </span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/blog/ui/" class="nav-link">页面</a></div><div class="nav-item"><a href="/blog/technology/" class="nav-link">技术</a></div> <a href="https://github.com/lyc2014/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/blog/imgs/avatar.jpg"> <div class="blogger-info"><h3>Leonardo</h3> <span>前端界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/blog/ui/" class="nav-link">页面</a></div><div class="nav-item"><a href="/blog/technology/" class="nav-link">技术</a></div> <a href="https://github.com/lyc2014/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript文章</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/ee825e/" class="sidebar-link">JavaScript中的this详解</a></li><li><a href="/blog/pages/16e3de/" class="sidebar-link">高阶函数</a></li><li><a href="/blog/pages/3c7486/" aria-current="page" class="active sidebar-link">JavaScript----执行环境、变量对象、作用域链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#ec-执行环境或执行上下文" class="sidebar-link">EC 执行环境或执行上下文</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#ecs-执行环境栈" class="sidebar-link">ECS  执行环境栈</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#vo-ao" class="sidebar-link">VO | AO</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#ao" class="sidebar-link">AO</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#示例" class="sidebar-link">示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/3c7486/#vo示例" class="sidebar-link">VO示例</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/3c7486/#ao-实例" class="sidebar-link">AO 实例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#作用域链" class="sidebar-link">作用域链</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/3c7486/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/blog/pages/b086bd/" class="sidebar-link">JS模块化规范笔记</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/blog/web/#前端" data-v-06225672>前端</a></li><li data-v-06225672><a href="/blog/web/#JavaScript文章" data-v-06225672>JavaScript文章</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/lyc2014" target="_blank" title="作者" class="beLink" data-v-06225672>liyuancheng</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-01-30</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">JavaScript----执行环境、变量对象、作用域链<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>这几天在看《javascript高级程序设计》，看到了执行环境和作用域链的时候，有些模糊。书中还是讲的不够具体。通过查找资料，来总结一下。</p> <ul><li>EC(执行环境或者执行上下文，Execution Context)</li> <li>ECS(执行环境栈Execution Context Stack)</li> <li>VO(变量对象, Variable Object) | AO(活动对象, Active Object)</li> <li>Scope Chain(作用域链) 和 [[Scope]] 属性</li></ul> <h2 id="ec-执行环境或执行上下文"><a href="#ec-执行环境或执行上下文" class="header-anchor">#</a> EC 执行环境或执行上下文</h2> <p>每当控制器到达ECMAScript可执行代码时，控制器就进入了一个执行上下文。
JavaScript中，EC分为三种</p> <ul><li>全局级别的代码------这个是默认的代码运行环境，一旦代码被载入，引擎最先进入的就是这个环境。</li> <li>函数级别的代码------当执行一个函数时，运行函数体中的代码。</li> <li>Eval的代码-------在Eval函数内运行的代码。</li></ul> <p>EC建立分为两个阶段</p> <ol><li>进入上下文阶段：发生函数调用时，但是在执行具体代码之前（比如，对函数参数进行具体化之前）</li> <li>执行代码阶段：变量赋值，函数引用，执行其他代码。</li></ol> <p>我们可以将EC看做是一个对象：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">EC</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">/* 函数中的arguments对象，参数，内部的变量以及函数声明 */</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token literal-property property">Scope</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">/*VO以及所有父执行上下文中的VO*/</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ecs-执行环境栈"><a href="#ecs-执行环境栈" class="header-anchor">#</a> ECS  执行环境栈</h2> <p>一系列活动的执行上下文从逻辑上形成一个栈。栈底总是全局上下文，栈顶是当前（活动的）执行上下文。当在不同的执行上下文间切换（退出的而进入新的执行上下文）的时候，栈会被修改（通过压栈或者退栈的形式）</p> <p>压栈：全局EC --&gt; 局部EC1 --&gt; 局部EC2 --&gt; 当前EC
出栈: 全局EC &lt;-- 局部EC1 &lt;-- 局部EC2 &lt;-- 当前EC</p> <p>我们可以用数组的形式来便是环境栈</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">ESC</span> <span class="token operator">=</span> <span class="token punctuation">[</span>局部<span class="token constant">EC</span>， 全局<span class="token constant">EC</span><span class="token punctuation">]</span>
</code></pre></div><p>每次控制器进入一个函数（哪怕该函数被递归调用或者作为构造器）， 都会发生压栈的操作。过程类似javascript数组的push和pop操作。</p> <p>当javascript代码文件被浏览器载入后，默认最先进入的是一个全局的执行上下文。当全局上下文中调用执行一个函数时，程序流就进入该被调用函数内，此时引擎就会为该函数创建一个新的执行上下文，并且将其压到执行上下文堆栈的顶部。浏览器总是执行当前在堆栈顶部的上下文，一旦执行完毕，该上下文就会从堆栈顶部被弹出，然后，进入其下的上下文执行代码。这样堆栈中的上下文就会被依次执行并且弹出堆栈，直到回到全局的上下文。</p> <h2 id="vo-ao"><a href="#vo-ao" class="header-anchor">#</a> VO | AO</h2> <p>每一个EC都对应一个变量对象VO, 在该EC中定义的所有变量和函数都存放在其对应的VO中。
VO分为全局上下文VO（全局对象，Global object，我们通常说的global对象）和函数上下文的AO。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上下文中的数据（变量声明(var)，函数声明(FD)， 函数参数(function arguments)）</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>进入执行上下文时，VO的初始化过程具体如下：</li></ol> <ul><li>函数的参数（当进入函数执行上下文时） ----变量对象的一个属性，其属性名就是形参的名字，其值就是实参的值；对于没有传递的参数，其值为undefined。</li> <li>函数声明(FunctionDeclaration, FD)  ----变量对象的一个属性，其属性名和值都是函数对象创建出来的；如果变量对象已经包含了相同名字的属性，则替换它的值</li> <li>变量声明（var, VariableDeclaration） -----变量对象的一个属性，其属性名即为变量名，其值为undefined;如果变量名和已经声明的函数名或者函数的参数名相同，则不会影响已经存在的属性（声明不会影响，赋值阶段会影响）。</li></ul> <p>注意： 该过程时有先后顺序的。</p> <ol start="2"><li>执行代码阶段时，VO中的一些属性undefined值将会被确定。</li></ol> <h2 id="ao"><a href="#ao" class="header-anchor">#</a> AO</h2> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>在函数的执行上下文中，VO是不能直接访问的。它主要扮演被称作活动对象(Active Object)（简称：AO）的角色。</p></div> <p>这句话怎么理解呢，就是当EC环境为函数时，我们访问的是AO， 而不是VO。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">VO</span><span class="token punctuation">(</span>functionContext<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">AO</span><span class="token punctuation">;</span>
</code></pre></div><p>AO是在进入函数的执行上下文时创建的，并为该对象初始化一个arguments属性，该属性的值为Arguments对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">AO</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">arguments</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">callee</span><span class="token operator">:</span><span class="token punctuation">,</span>
        <span class="token literal-property property">length</span><span class="token operator">:</span><span class="token punctuation">,</span>
        properties<span class="token operator">-</span>indexes<span class="token operator">:</span> <span class="token punctuation">,</span><span class="token comment">//函数传参参数值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FD的形式只能是如下这样（函数声明，非函数表达式）：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h2> <h3 id="vo示例"><a href="#vo示例" class="header-anchor">#</a> VO示例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> x   <span class="token comment">// 变量声明 不会影响已经存在的属性</span>
<span class="token function">alert</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//function </span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span>
<span class="token function">alert</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// 10</span>
x <span class="token operator">=</span> <span class="token number">20</span>
<span class="token keyword">function</span> <span class="token function">x</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token function">alert</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// 20</span>
</code></pre></div><p>进入执行上下文时</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>ECObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;x&quot;</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行代码时:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>ECObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// 与函数x同名，替换掉，先是10，后变成20</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于以上的过程，我们详细解释下。
在进入上下文的时候，VO会被填充函数声明；同一阶段，还有变量声明'x', 但是，正如此前提到的，变量声明是在函数声明和函数形参之后，并且变量声明不会对已经存在的同样名字的函数声明和函数形参发生冲突。因此，在进入上下文的阶段，vo填充如下形式。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">VO</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token constant">VO</span><span class="token punctuation">[</span><span class="token string">'x] = &lt;引用了函数声明'</span>x'<span class="token operator">&gt;</span>
<span class="token comment">/**
 * 发现var x = 10;
 * 如果函数&quot;x&quot;还未定义 则 &quot;x&quot; 为undefined。
 * 但是例子中的 &quot;x&quot; 已引用了函数声明， 变量声明并不会影响同名的函数值
*/</span>
</code></pre></div><p>执行代码阶段， VO被修改如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">VO</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token constant">VO</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">20</span>
</code></pre></div><p>如下例子，进入上下文阶段，变量存储在VO中（因此，尽管else的代码块永远不会执行到，而&quot;b&quot;却仍然在VO中）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span>  a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
<span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token function">alert</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//undefined, but not &quot;b&quot; is not defined。</span>
</code></pre></div><h3 id="ao-实例"><a href="#ao-实例" class="header-anchor">#</a> AO 实例</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">test</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token keyword">function</span> <span class="token function">d</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">var</span> <span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">x</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><p>当进入test(10)的执行上下文时，它的AO为：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>testEC <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">AO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">arguments</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">callee</span><span class="token operator">:</span> test<span class="token punctuation">,</span>
            <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;d&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">e</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由此可见，在建立阶段，VO除了arguments, 函数的声明，以及参数被赋予了具体的值，其它的变量属性默认都是undefined。函数表达式不会对VO造成影响，因此， (function x () {}) 并不会存在于VO中。</p> <p>当执行test(10)时，它的AO为：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>testEC <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">AO</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">arguments</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">callee</span><span class="token operator">:</span> test<span class="token punctuation">,</span>
            <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">c</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;d&quot;</span><span class="token operator">&gt;</span>
        <span class="token literal-property property">e</span><span class="token operator">:</span> <span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;e&quot;</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可见，只有在这个阶段，变量属性才会被赋具体的值</p> <h2 id="作用域链"><a href="#作用域链" class="header-anchor">#</a> 作用域链</h2> <p>在执行上下文的作用域中查找变量的过程被称为标识符解析(indentifier resolution)，这个过程的实现依赖于函数内部另一个同执行上下文相关联的对象-----作用域链。作用域链是一个有序链表，其包含着用以告诉JavaScript解析器一个标识符关联着哪一个变量的对象。而每个执行上下文都有其自己的作用域链Scope。</p> <p>一句话：作用域链Scope其实就是对执行上下文EC中的变量对象VO|AO有序访问的链表。能按顺序访问到VO|AO，就能访问到其中存放的变量和函数的定义。</p> <p>Scope定义如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Scope <span class="token operator">=</span> <span class="token constant">AO</span> <span class="token operator">|</span> <span class="token constant">VO</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>其中，AO始终在Scope的最前端，即活动对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Scope <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">AO</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>这说明，作用域链是在函数创建时就已经有了。
那么[[Scope]]是什么呢？</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>[[Scope]]是一个包含了所有上层变量对象的分层链，它属于当前函数指向上下文，并在函数创建的时候，保存在函数中。</p></div> <p>[[Scope]]是在函数创建的时候保存起来的---静态（不变的），只有一次并且一直都存在----直到函数销毁。比方说，哪怕
函数永远都不能被调用，[[Scope]]属性也已经保存在函数对象上了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">f1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">f2</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> y
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上示例中， f2的[[scope]]属性可以表示如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>f2<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    f2OuterContext<span class="token punctuation">.</span><span class="token constant">VO</span>
<span class="token punctuation">]</span>
</code></pre></div><p>而f2的外部EC的所有上层变量包括了f1的活动对象f1Context.AO，再往外一层的EC，就是global对象了。
所以，具体我们可以表示如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>f2<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    f1Context<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span>
    globalContext<span class="token punctuation">.</span><span class="token constant">VO</span>
<span class="token punctuation">]</span>
</code></pre></div><p>对于EC执行环境是函数来说，那么它的scope表示为:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>functionContext<span class="token punctuation">.</span>Scope <span class="token operator">=</span>  functionContext<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token operator">+</span> <span class="token keyword">function</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>注意，以上代码的表示，也体现了[[scope]]和Scope的差异，Scope是EC的属性，而[[scope]]则是函数的静态属性。</p> <p>(由于AO|VO在进入执行上下文和执行代码阶段不同，所以，这里及以后Scope的表示，都默认为是执行代码阶段的Scope，而对于静态属性[[scope]而言，则是函数声明时就创建了])</p> <p>对于以上的代码EC，我们可以给出其Scope的表示</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exampleEC <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">Scope</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        f2Context<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token operator">+</span> f2<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        f1Context<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token operator">+</span> f1<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        globalContext<span class="token punctuation">.</span><span class="token constant">VO</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来，我们给出以上其它值的表示:</p> <ul><li>globalContext.VO</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>globalContext<span class="token punctuation">.</span><span class="token constant">VO</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token literal-property property">f1</span><span class="token operator">:</span><span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;f1&quot;</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>f2Context.AO</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>f2Context<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>f2.[scope]</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>f2Context<span class="token punctuation">.</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span>
  f1Context<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">arguments</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token literal-property property">callee</span><span class="token operator">:</span>f1<span class="token punctuation">,</span>
      <span class="token literal-property property">length</span><span class="token operator">:</span><span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token literal-property property">f2</span><span class="token operator">:</span><span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;f2&quot;</span><span class="token operator">&gt;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  globalContext<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token literal-property property">f1</span><span class="token operator">:</span><span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;f1&quot;</span><span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>f1Context.AO</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>f1Context<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token operator">=</span><span class="token punctuation">{</span>
  <span class="token literal-property property">arguments</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">callee</span><span class="token operator">:</span>f1<span class="token punctuation">,</span>
    <span class="token literal-property property">length</span><span class="token operator">:</span><span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token literal-property property">f2</span><span class="token operator">:</span><span class="token operator">&lt;</span>reference to FunctionDeclaration <span class="token string">&quot;f2&quot;</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>f1.<a href="f1%E7%9A%84%E6%89%80%E6%9C%89%E4%B8%8A%E5%B1%82EC%E7%9A%84VO">[scope]</a></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>f1<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span>
  globalContext<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token literal-property property">f1</span><span class="token operator">:</span><span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>好，我们知道，作用域链Scope呢，是用来有序访问VO|AO中的变量和函数，对于上面的示例，我们给出访问的过程：</p> <ul><li>x,f1</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">-</span> <span class="token string">&quot;x&quot;</span>
<span class="token operator">--</span> f2Context<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token comment">// not found</span>
<span class="token operator">--</span> f1Context<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token comment">// not found</span>
<span class="token operator">--</span> globalContext<span class="token punctuation">.</span><span class="token constant">VO</span> <span class="token comment">// found - 10</span>
</code></pre></div><p>f1的访问过程类似。</p> <ul><li>y</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">-</span> <span class="token string">&quot;y&quot;</span>
<span class="token operator">--</span> f2Context<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token comment">// not found</span>
<span class="token operator">--</span> f1Context<span class="token punctuation">.</span><span class="token constant">AO</span> <span class="token comment">// found -20</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ol><li>EC分为两个阶段，进入执行上下文和执行代码。</li> <li>ECStack管理EC的压栈和出栈。</li> <li>每个EC对应一个作用域链Scope，VO|AO（AO，VO只能有一个），this。</li> <li>函数EC中的Scope在进入函数EC时创建，用来有序访问该EC对象AO中的变量和函数。</li> <li>函数EC中的AO在进入函数EC时，确定了Arguments对象的属性；在执行函数EC时，其它变量属性具体化。</li> <li>函数的[[scope]]属性在函数创建时就已经确定，并保持不变。</li></ol></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/30/2023, 11:29:48 AM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/blog/pages/16e3de/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">高阶函数</div></a> <a href="/blog/pages/b086bd/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">JS模块化规范笔记</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/pages/16e3de/" class="prev">高阶函数</a></span> <span class="next"><a href="/blog/pages/b086bd/">JS模块化规范笔记</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/pages/d8cae9/"><div>
            01.Buffer的神秘面纱
            <!----></div></a> <span class="date">02-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/pages/e18f26/"><div>
            简易webpack打包器
            <!----></div></a> <span class="date">04-16</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/pages/b086bd/"><div>
            JS模块化规范笔记
            <!----></div></a> <span class="date">04-10</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.4a3d1442.js" defer></script><script src="/blog/assets/js/2.e2e64146.js" defer></script><script src="/blog/assets/js/10.2235f657.js" defer></script>
  </body>
</html>
